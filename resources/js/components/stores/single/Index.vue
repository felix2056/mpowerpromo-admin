<template>
    <div class="dashboard">
        <navigation />

        <div id="main" class="slideout-panel slideout-panel-left">
            <div class="main-panel container-fluid pt-3">
                <div class="no-gutters mt-n3">
                    <div class="d-flex store-editor-navbar align-items-center no-gutters px-0 justify-content-between">
                        <nav class="navbar pl-0 col navbar-white navbar-expand">
                            <ul class="navbar-nav d-flex align-items-center justify-content-start intro-store-navbar">
                                <div><a class="btn btn-link"><i class="far fa-sign-out fa-1x fa-rotate-180"></i></a></div>
                                <li class="nav-item b-nav-dropdown dropdown" id="__BVID__2078"><a role="button"
                                        aria-haspopup="true" aria-expanded="false" href="#" target="_self"
                                        class="nav-link dropdown-toggle" id="__BVID__2078__BV_toggle_"
                                        aria-controls="__BVID__2078__BV_toggle_menu_"><span>Content</span></a>
                                    <ul tabindex="-1" class="dropdown-menu" aria-labelledby="__BVID__2078__BV_toggle_"
                                        id="__BVID__2078__BV_toggle_menu_">
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-folder-tree"></i>
                                                    Categories
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-grip-horizontal"></i>
                                                    Components
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-code"></i>
                                                    Head Tags
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-images"></i>
                                                    Media
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-file"></i>
                                                    Pages
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-brush"></i>
                                                    Theme
                                                    <!---->
                                                </div>
                                            </a></li>
                                    </ul>
                                </li>
                                <li class="nav-item b-nav-dropdown dropdown" id="__BVID__2098"><a role="button"
                                        aria-haspopup="true" aria-expanded="false" href="#" target="_self"
                                        class="nav-link dropdown-toggle" id="__BVID__2098__BV_toggle_"
                                        aria-controls="__BVID__2098__BV_toggle_menu_"><span>Products</span></a>
                                    <ul tabindex="-1" class="dropdown-menu" aria-labelledby="__BVID__2098__BV_toggle_"
                                        id="__BVID__2098__BV_toggle_menu_">
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-tshirt"></i>
                                                    Products
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-warehouse-alt fa-fw mr-2"></i>
                                                    Suppliers
                                                    <!---->
                                                </div>
                                            </a></li>
                                    </ul>
                                </li>
                                <li class="nav-item b-nav-dropdown dropdown" id="__BVID__2106"><a role="button"
                                        aria-haspopup="true" aria-expanded="false" href="#" target="_self"
                                        class="nav-link dropdown-toggle" id="__BVID__2106__BV_toggle_"
                                        aria-controls="__BVID__2106__BV_toggle_menu_"><span>Marketing</span></a>
                                    <ul tabindex="-1" class="dropdown-menu" aria-labelledby="__BVID__2106__BV_toggle_"
                                        id="__BVID__2106__BV_toggle_menu_">
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class="text-muted position-relative"><i
                                                        class="fa-fw mr-2 far fa-rss-square"></i>
                                                    Product Feed
                                                    <i class="fas fa-circle fa-xs text-primary ml-1 position-absolute"></i>
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-share fa-fw"></i>
                                                    Social Media
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-robot"></i>
                                                    Robots.txt
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-sitemap"></i>
                                                    Sitemaps
                                                    <!---->
                                                </div>
                                            </a></li>
                                    </ul>
                                </li>
                                <li class="nav-item b-nav-dropdown dropdown" id="__BVID__2120"><a role="button"
                                        aria-haspopup="true" aria-expanded="false" href="#" target="_self"
                                        class="nav-link dropdown-toggle" id="__BVID__2120__BV_toggle_"
                                        aria-controls="__BVID__2120__BV_toggle_menu_"><span>Selling</span></a>
                                    <ul tabindex="-1" class="dropdown-menu" aria-labelledby="__BVID__2120__BV_toggle_"
                                        id="__BVID__2120__BV_toggle_menu_">
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-users fa-fw mr-2"></i>
                                                    Customers
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-tag"></i>
                                                    Discounts &amp; Specials
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-credit-card"></i>
                                                    Payment
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-chart-line fa-fw mr-2"></i>
                                                    Reports
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-comment-alt-lines fa-fw mr-2"></i>
                                                    Reviews
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-shipping-fast"></i>
                                                    Shipping
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-money-bill"></i>
                                                    Taxes
                                                    <!---->
                                                </div>
                                            </a></li>
                                    </ul>
                                </li>
                                <li class="nav-item b-nav-dropdown dropdown" id="__BVID__2143"><a role="button"
                                        aria-haspopup="true" aria-expanded="false" href="#" target="_self"
                                        class="nav-link dropdown-toggle" id="__BVID__2143__BV_toggle_"
                                        aria-controls="__BVID__2143__BV_toggle_menu_"><span>Settings</span></a>
                                    <ul tabindex="-1" class="dropdown-menu" aria-labelledby="__BVID__2143__BV_toggle_"
                                        id="__BVID__2143__BV_toggle_menu_">
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-image"></i>
                                                    Artwork
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-info-circle"></i>
                                                    Information
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-envelope"></i>
                                                    Communication
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-sliders-h"></i>
                                                    Configuration
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-shopping-cart"></i>
                                                    Carts
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-user-shield fa-fw mr-2"></i>
                                                    Customer Roles
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-box-full fa-fw mr-2"></i>
                                                    Fulfillment
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-key"></i>
                                                    Single Sign On
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-sliders-h"></i>
                                                    Reference Fields
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-users fa-fw mr-2"></i>
                                                    Users
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2 far fa-play fa-fw mr-2"></i>
                                                    Walkthrough
                                                    <!---->
                                                </div>
                                            </a></li>
                                        <li role="presentation" class="text-nowrap"><a role="menuitem" href="#"
                                                target="_self" class="dropdown-item">
                                                <div class=""><i class="fa-fw mr-2"></i>

                                                    <!---->
                                                </div>
                                            </a></li>
                                    </ul>
                                </li>
                            </ul>
                        </nav>

                        <div class="col d-flex justify-content-center"><img
                                src="https://www.adobe.com/content/dam/cc/us/en/creativecloud/design/discover/mascot-logo-design/mascot-logo-design_fb-img_1200x800.jpg"
                                title="Adobe" class="mr-2" style="height: 40px;"></div>
                        <div class="text-right d-flex align-items-center col justify-content-end">
                            <div class="d-flex align-items-center">
                                <li class="nav-item b-nav-dropdown dropdown d-none d-sm-inline-block intro-store-resize"
                                    id="__BVID__4893"><a role="button" aria-haspopup="true" aria-expanded="false" href="#"
                                        target="_self" class="nav-link dropdown-toggle" id="__BVID__4893__BV_toggle_"
                                        aria-controls="__BVID__4893__BV_toggle_menu_"><span>%</span></a>
                                    <ul tabindex="-1" class="dropdown-menu" aria-labelledby="__BVID__4893__BV_toggle_"
                                        id="__BVID__4893__BV_toggle_menu_">
                                        <li role="presentation"><a role="menuitem" href="#" target="_self"
                                                class="dropdown-item"><a class="btn btn-link text-secondary">0%</a></a></li>
                                        <li role="presentation"><a role="menuitem" href="#" target="_self"
                                                class="dropdown-item"><a class="btn btn-link">25%</a></a></li>
                                        <li role="presentation"><a role="menuitem" href="#" target="_self"
                                                class="dropdown-item"><a class="btn btn-link text-secondary">50%</a></a>
                                        </li>
                                        <li role="presentation"><a role="menuitem" href="#" target="_self"
                                                class="dropdown-item"><a class="btn btn-link text-secondary">75%</a></a>
                                        </li>
                                    </ul>
                                </li>
                                <div class="d-flex align-items-center intro-store-browser-device"><a
                                        class="btn btn-link d-none d-lg-inline-block"><i
                                            class="far fa-desktop fa-1x"></i></a><a
                                        class="btn btn-link d-none d-lg-inline-block"><i
                                            class="far fa-tablet fa-1x"></i></a><a
                                        class="btn btn-link d-none d-lg-inline-block"><i
                                            class="far fa-mobile fa-1x"></i></a></div><!---->
                                <div data-v-9d260a2e="" class="intro-store-help mr-2">
                                    <div data-v-9d260a2e="" class="dropdown b-dropdown btn-group" id="__BVID__4904">
                                        <!----><button aria-haspopup="menu" aria-expanded="false" type="button"
                                            class="btn dropdown-toggle btn-link dropdown-toggle-no-caret"
                                            id="__BVID__4904__BV_toggle_">Need Help?</button>
                                        <ul role="menu" tabindex="-1" class="dropdown-menu mr-2 dropdown-menu-right"
                                            aria-labelledby="__BVID__4904__BV_toggle_">
                                            <li data-v-9d260a2e="" role="presentation" class="px-4 pt-2">
                                                <h6>Need help setting up your store?</h6>
                                                <div class="text-center"><img class="w-50"
                                                        src="https://mpower-app-production.s3.amazonaws.com/introjs/90381-support-centre.gif">
                                                </div>
                                            </li>
                                            <li data-v-9d260a2e="" role="presentation"><a role="menuitem"
                                                    href="https://support.mpowerpromo.com/space/MP/74252319/Stores"
                                                    rel="noopener" target="_blank" class="dropdown-item">
                                                    <div data-v-9d260a2e=""><i class="fa fa-book mr-2"></i>View store
                                                        documentation</div>
                                                </a></li>
                                            <li data-v-9d260a2e="" role="presentation"><a role="menuitem"
                                                    href="https://support.mpowerpromo.com/portal/1/create/21" rel="noopener"
                                                    target="_blank" class="dropdown-item"><i data-v-9d260a2e=""
                                                        class="fa fa-life-ring mr-2"></i>Submit a support request</a></li>
                                            <li data-v-9d260a2e="" role="presentation"><a role="menuitem"
                                                    href="https://calendly.com/mpower-support" rel="noopener"
                                                    target="_blank" class="dropdown-item"><i data-v-9d260a2e=""
                                                        class="fa fa-headset mr-2"></i>Schedule a call</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex store-editor row no-gutters">
                        <StoreEditorSidebarStage1 v-if="shouldShowSidebarEditorStage1"></StoreEditorSidebarStage1>
                        <StoreEditorSidebarStage2 v-if="shouldShowSidebarEditorStage2" @goBack="handleReceivedData({event: 'clickElem', id: null, type: null})"></StoreEditorSidebarStage2>
                        <StoreEditorSidebarStage3 v-if="shouldShowSidebarEditorStage3"></StoreEditorSidebarStage3>

                        <div class="flex-fill align-center bg-light store-preview-container overlay"
                            style="position: relative;">
                            <div class="d-flex align-items-center bg-white p-2 border-bottom">
                                <input type="text" :value="store_url + '?noCachePage=1'" class="form-control bg-light border-0 rounded-pill" readonly>
                                <a title="Reload and clear cache" class="ml-2 btn btn-circle btn-light">
                                    <i class="far fa-redo-alt text-secondary fa-fw"></i>
                                </a>
                            </div>
                            <iframe ref="storeEditorIframe"
                                @load="iframeLoaded"
                                title="Online store preview"
                                name="thumbnails" 
                                frameborder="0" 
                                class="store-preview-iframe overlay"
                                sandbox="allow-same-origin allow-forms allow-popups allow-scripts allow-modals">
                            </iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <notification />
    </div>
</template>

<script>
import { mapState, mapGetters, mapActions } from 'vuex';

import Navigation from '../../includes/navigation.vue'
import Notification from '../../includes/notification.vue'

import StoreEditorSidebarStage1 from './StoreEditorSidebarStage1.vue'
import StoreEditorSidebarStage2 from './StoreEditorSidebarStage2.vue'
import StoreEditorSidebarStage3 from './StoreEditorSidebarStage3.vue'

export default {
    components: {
        Navigation, 
        Notification,
        StoreEditorSidebarStage1,
        StoreEditorSidebarStage2,
        StoreEditorSidebarStage3
    },

    data() {
        return {
            isLoading: false,
            validationErrors: {},
        }
    },

    computed: {
        ...mapState({
            shouldShowSidebarEditorStage1: state => state.theme.shouldShowSidebarEditorStage1,
            shouldShowSidebarEditorStage2: state => state.theme.shouldShowSidebarEditorStage2,
            shouldShowSidebarEditorStage3: state => state.theme.shouldShowSidebarEditorStage3,
        }),
        
        ...mapGetters({
            store: 'userstore/store',
            selectedComponent: 'components/selectedComponent',
            selectedBlock: 'components/selectedBlock',
        }),

        store_url() {
            return 'http://' + this.store.subdomain + '.' + this.store.domain
        }
    },

    created() {
        this.fetchStore()
    },

    methods: {
        ...mapActions({
            getStore: 'userstore/get',
            showSidebarEditor: 'theme/showSidebarEditor',
            setSelectComponent: 'components/selectComponent',
            setSelectBlock: 'components/selectBlock',
        }),

        async fetchStore() {
            try {
                this.isLoading = true

                const response = await this.getStore({
                    store: this.$route.params.slug
                });
            } catch (error) {
                console.log(error)
            } finally {
                this.isLoading = false;
                this.showSidebarEditor('stage1');
                this.$refs.storeEditorIframe.src = this.store_url + '?noCachePage=1';
            }
        },

        iframeLoaded() {
            const iframe = this.$refs.storeEditorIframe.contentWindow;
            const data = {
                action: 'elementInteractions',
            };

            iframe.postMessage(data, '*'); // Send a message to request adding event listeners

            // Listen for messages sent from the iframe
            window.addEventListener('message', (event) => {
                if (event.source === iframe && event.data.action === 'dataFromEditorIframe') {
                    const receivedData = event.data.data;
                    console.log('Data received from iframe:', receivedData);

                    this.handleReceivedData(receivedData);
                }
            });
        },

        async handleReceivedData(receivedData) {
            if (receivedData.event === 'clickElem') {
                // get data_id and data_type
                const data_id = receivedData.id;
                const data_type = receivedData.type;
                const data_parent_id = receivedData.parent_id || null;
                
                let data_structure = await this.determineStructureFromType(data_type);
                if (data_structure === 'component') {
                    let selectComponent = await this.setSelectComponent({
                        id: data_id,
                        type: data_type,
                    });
                    
                    await this.setSelectBlock({
                        id: null,
                        type: null,
                    });

                    // activate sidebar editor stage 2
                    if (selectComponent) this.showSidebarEditor('stage2');
                } else if (data_structure === 'block') {
                    if (data_parent_id) {
                        await this.setSelectComponent({
                            id: data_parent_id,
                            type: data_type,
                        });

                        let selectBlock = await this.setSelectBlock({
                            id: data_id,
                            type: data_type,
                        });

                        // activate sidebar editor stage 3
                        if (selectBlock) this.showSidebarEditor('stage3');
                    }
                } else {
                    let selectComponent = await this.setSelectComponent({
                        id: null,
                        type: null,
                    });
                    
                    let selectBlock = await this.setSelectBlock({
                        id: null,
                        type: null,
                    });

                    // activate sidebar editor stage 1
                    this.showSidebarEditor('stage1');
                }
            }
        },

        async determineStructureFromType(type) {
            if (type === 'announcement-bar') return 'component';
            if (type === 'announcement-block') return 'block';

            return null;
        }
    },
}
</script>